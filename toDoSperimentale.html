<!DOCTYPE html>
<html>
<head>
  <title>ToDo</title>
  <link rel="icon" href="./icone/checked.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="./css/stileToDo.css">
</head>

<body onload="inizializzaStorageUtenti()">
<div id="myDIV" class="header">
  <span onclick="newElement()" id="addBtn" class="addBtn">+</span>
  <input type="text" id="myInput" placeholder="Aggiungi un'attività">
  <span onclick="resetStorageUtenti()" id="rmvBtn" class="rmvBtn">C</span>
</div>

<ul id="myUL">
</ul>
<div class="bordo"></div>

<script>
  // Aggiunge la spunta quando premi su un taskSperimentale
  var list = document.querySelector('ul');
  list.addEventListener('click', function(ev) {
    if (ev.target.tagName === 'LI') {
      ev.target.classList.toggle('checked');
    }
  }, false);
  
  // Aggiunge un taskSperimentale quando premi invio sulla barra di input
  var inputTaskSperimentale = document.getElementById("myInput");
  inputTaskSperimentale.addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
     event.preventDefault();
     document.getElementById("addBtn").click();
    }
  });

  // Create a new list item when clicking on the "Add" button
  function newElement() {
    var li = document.createElement("li");
    var oldItems = JSON.parse(localStorage.getItem('taskSperimentale'))||[];
    var newItem = document.getElementById("myInput").value;
    var t = document.createTextNode(newItem);
    //console.log(newItem);

    var controlloOggetto = "\\\""+newItem+"\\\"";
    var storageAttuale = JSON.stringify(localStorage.taskSperimentale);

    if (storageAttuale.includes(controlloOggetto)){
      alert("Attività già presente");
      document.getElementById("myInput").value = "";
      return false;
    }
    if (newItem.includes("\"")){
      newItem=newItem.replace(/\"/g, "''");
    }
    if (newItem === '') {
      alert("Non hai scritto nulla");
      return false;
    }
    oldItems.push(newItem);
    localStorage.setItem('taskSperimentale', JSON.stringify(oldItems));
    li.appendChild(t);
    if (newItem === '') {
      alert("Non hai scritto nulla");
    } else {
      document.getElementById("myUL").appendChild(li);
      var span = document.createElement("SPAN");
      var txt = document.createTextNode("Nuovo!");
      span.className = "nuovo";
      span.appendChild(txt);
      li.appendChild(span)
    }
    document.getElementById("myInput").value = "";
  }

  function inizializzaStorageUtenti(){
    if (typeof(localStorage.taskSperimentale)=="undefined") {
      localStorage.taskSperimentale="[]" ;
    }
    var ls=JSON.parse(localStorage.taskSperimentale);
    var lsL=ls.length;
    ls=ls.sort();
    for (i = 0; i<lsL; i+1) {
      var li = document.createElement("li");
      var passata=JSON.stringify(ls[i]).replace(/\"/g, "");
      console.log(passata);
      var t = document.createTextNode(passata);
      li.appendChild(t);
      document.getElementById("myUL").appendChild(li);
      var span = document.createElement("SPAN");
      var txt = document.createTextNode("\u00D7");
      span.className = "close";
      span.appendChild(txt);
      li.appendChild(span);

      // Click on a close button to hide the current list item
      var close = document.getElementsByClassName("close");
      var i;
      for (i = 0; i < close.length; i++) {
        close[i].onclick = function() {
          var contenuto = this.parentElement;
          contenuto.style.display = "none";
          var taskSperimentaleAttuale = contenuto.textContent.replace("×", "");
          var taskSperimentaleRimozione = JSON.stringify(localStorage.taskSperimentale);
          var taskSperimentaleDaRimuovere = "\\\""+taskSperimentaleAttuale+"\\\"";

          taskSperimentaleRimozione=taskSperimentaleRimozione.replace(taskSperimentaleDaRimuovere, "");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\,\]", "\]");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\[\,", "\[");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\,\,", "\,");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\\\"\\\"", "");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\\\"\\\"\,", "");
          taskSperimentaleRimozione=taskSperimentaleRimozione.replace("\,\\\"\\\"", "");
          
          localStorage.setItem('taskSperimentale', JSON.parse(taskSperimentaleRimozione));
        }
      }
    }
  }

  function resetStorageUtenti(){
    localStorage.taskSperimentale="[]";
    window.location.reload();
  }
</script>

</body>
<!--
  Il codice è mezzo preso in prestito dagli esempi su w3schools,
  il resto è magia del mio cuore.

  Le icone sono di https://icons8.it/
-->
</html>