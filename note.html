<!DOCTYPE html>
<html>
<head>
  <title>ToDo</title>
  <link rel="icon" href="./icone/checked.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="./css/stileNote.css">
</head>

<body onload="inizializzaStorageUtenti()">

<div id="myDIV" class="header">
  <span onclick="newElement()" id="addBtn" class="addBtn baseBtn">+</span>
  <input type="text" id="myInput" placeholder="Aggiungi una nota">
  <span onclick="openForm()" class="menuBtn baseBtn">M</span>
</div>

<div class="dataOggi" id="dataOggi"></div>

<ul id="myUL"></ul>

<div class="form-cancella" id="prova1">
  <table style="margin-left: auto; margin-right: auto;">
    <td onclick="closeForm()" class="varioBtn baseBtn">Chiudi menù</td>
    <td onclick="editModeOn()" class="varioBtn baseBtn">Edit On</td>
    <td onclick="editModeOff()" class="varioBtn baseBtn">Edit Off</td>
    <td onclick="resetStorageUtenti()" id="rmvBtn" class="varioBtn baseBtn">Reset</td>
  </table>
</div>

<script>  
  var dOg = new Date();
  var dataGiorno = dOg.getDate();
  var dataMese = dOg.getMonth()+1;
  var dataAnno = dOg.getFullYear();
  var dataCompleta = dataGiorno+"."+dataMese+"."+dataAnno;
  document.getElementById("dataOggi").innerHTML = dataCompleta;

  // Aggiunge un notePB quando premi invio sulla barra di input
  var inputNotePB = document.getElementById("myInput");
  inputNotePB.addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
     event.preventDefault();
     document.getElementById("addBtn").click();
    }
  });

  // Create a new list item when clicking on the "Add" button
  function newElement() {
    var li = document.createElement("li");
    var oldItems = JSON.parse(localStorage.getItem('notePB'))||[];
    var newItem = document.getElementById("myInput").value;
    var t = document.createTextNode(newItem);
    //console.log(newItem);

    var controlloOggetto = "\\\""+newItem+"\\\"";
    var storageAttuale = JSON.stringify(localStorage.notePB);

    if (storageAttuale.includes(controlloOggetto)){
      alert("Attività già presente");
      document.getElementById("myInput").value = "";
      return false;
    }
    if (newItem.includes("\"")){
      newItem=newItem.replace(/\"/g, "''");
    }
    if (newItem === '') {
      alert("Non hai scritto nulla");
      return false;
    }
    oldItems.push(newItem);
    localStorage.setItem('notePB', JSON.stringify(oldItems));
    li.appendChild(t);
    if (newItem === '') {
      alert("Non hai scritto nulla");
    } else {
      window.location.reload();
    }
    document.getElementById("myInput").value = "";
  }

  function editModeOff() {
    var elems = document.getElementsByClassName('close');
    var elems2 = document.getElementsByClassName('AO');
    for (var i=0;i<elems.length;i+=1){
      elems[i].style.display = 'none';
      elems2[i].style.paddingLeft = '8px';
    }
  }

  function editModeOn() {
    var elems = document.getElementsByClassName('close');
    var elems2 = document.getElementsByClassName('AO');
    for (var i=0;i<elems.length;i+=1){
      elems[i].style.display = 'block';
      elems2[i].style.paddingLeft = '50px';
    }
  }

  function inizializzaStorageUtenti(){
    if (typeof(localStorage.notePB)=="undefined") {
      localStorage.notePB="[]" ;
    }
    var ls=JSON.parse(localStorage.notePB);
    var lsL=ls.length;
    for (i = 0; i<lsL; i+1) {
      var li = document.createElement("li");
      var passata=JSON.stringify(ls[i]).replace(/\"/g, "");
      console.log(passata);
      var t = document.createTextNode(passata);
      li.appendChild(t);
      li.className="AO";
      document.getElementById("myUL").appendChild(li);
      var span = document.createElement("SPAN");
      var txt = document.createTextNode("\u00D7");
      span.className = "close";
      span.appendChild(txt);
      li.appendChild(span);

      // Elimina il notePB relativo
      var close = document.getElementsByClassName("close");
      var i;
      for (i = 0; i < close.length; i++) {
        close[i].onclick = function() {
          var contenuto = this.parentElement;
          contenuto.style.display = "none";
          var notePBAttuale = contenuto.textContent.replace("×", "");
          var notePBRimozione = JSON.stringify(localStorage.notePB);
          var notePBDaRimuovere = "\\\""+notePBAttuale+"\\\"";

          notePBRimozione=notePBRimozione.replace(notePBDaRimuovere, "");
          notePBRimozione=notePBRimozione.replace("\,\]", "\]");
          notePBRimozione=notePBRimozione.replace("\[\,", "\[");
          notePBRimozione=notePBRimozione.replace("\,\,", "\,");
          notePBRimozione=notePBRimozione.replace("\\\"\\\"", "");
          notePBRimozione=notePBRimozione.replace("\\\"\\\"\,", "");
          notePBRimozione=notePBRimozione.replace("\,\\\"\\\"", "");
          
          localStorage.setItem('notePB', JSON.parse(notePBRimozione));
        }
      }
    }
  }

  function resetStorageUtenti(){
    localStorage.notePB="[]";
    window.location.reload();
  }

  function openForm() {
    document.getElementById("prova1").style.display = "block";
  }

  function closeForm() {
    document.getElementById("prova1").style.display = "none";
  }
</script>

</body>
<!--
  Il codice è mezzo preso in prestito dagli esempi su w3schools,
  il resto è magia del mio cuore.

  Le icone sono di https://icons8.it/
-->
</html>